<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Candy Crush Full Prototype</title>
<style>
body {
    margin:0; padding:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; background:#ffe6f0; user-select:none;
}
#score, #quest, #level, #moves {
    font-size:18px; margin:3px; font-weight:bold; color:#ff3366;
}
#gameBoard {
    display:grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); gap:2px; touch-action:none;
}
.candy {
    width:60px; height:60px; border-radius:10px; display:flex; justify-content:center; align-items:center;
    font-size:36px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.2); cursor:pointer;
    transition: transform 0.2s ease, background 0.2s ease;
}
.special {
    box-shadow:0 0 15px 3px #ff0;
}
</style>
</head>
<body>

<div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
<div id="level">‡∏î‡πà‡∏≤‡∏ô: 1</div>
<div id="moves">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: 20</div>
<div id="quest">‡πÄ‡∏Ñ‡∏ß‡∏™: ‡πÄ‡∏Å‡πá‡∏ö üçé 0/5</div>
<div id="gameBoard"></div>

<script>
const fruits = ['üçé','üçå','üçá','üçì','üçç'];
let boardSize = 8;
let board = [], boardEl=document.getElementById('gameBoard');
let score=0, level=1, movesLeft=20, questTarget='üçé', questCount=0, questGoal=5;
let selected=null, moveAllowed=true;

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô
function initBoard(){
    board=[]; boardEl.innerHTML='';
    for(let r=0;r<boardSize;r++){
        let row=[];
        for(let c=0;c<boardSize;c++){
            let f = fruits[Math.floor(Math.random()*fruits.length)];
            let candy = document.createElement('div');
            candy.classList.add('candy'); candy.innerText=f;
            candy.dataset.row=r; candy.dataset.col=c;
            boardEl.appendChild(candy);
            row.push(f);
        }
        board.push(row);
    }
}
function renderBoard(){
    for(let r=0;r<boardSize;r++){
        for(let c=0;c<boardSize;c++){
            boardEl.children[r*boardSize+c].innerText = board[r][c];
        }
    }
}
function highlight(pos,on=true){
    const candy = boardEl.children[pos.r*boardSize + pos.c];
    if(on) candy.classList.add('special'); else candy.classList.remove('special');
}
function isAdjacent(a,b){
    return (Math.abs(a.r-b.r)+Math.abs(a.c-b.c))===1;
}
function selectCandy(r,c){
    if(!moveAllowed) return;
    if(!selected){ selected={r,c}; highlight(selected,true); }
    else {
        highlight(selected,false);
        if(isAdjacent(selected,{r,c})){
            moveAllowed=false;
            swap(selected,{r,c});
            selected=null;
            movesLeft--; updateMoves();
            setTimeout(()=>moveAllowed=true,300);
        } else { selected={r,c}; highlight(selected,true); }
    }
}
function swap(a,b,check=true){
    [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
    renderBoard();
    if(check){
        setTimeout(()=>{
            if(!checkMatches()){
                [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
                renderBoard();
            } else { checkWin(); }
        },200);
    }
}

// Match check
function checkMatches(){
    let matchFound=false, remove=[];
    for(let r=0;r<boardSize;r++){
        for(let c=0;c<boardSize-2;c++){
            if(board[r][c]!=='' && board[r][c]===board[r][c+1] && board[r][c]===board[r][c+2]){
                matchFound=true; remove.push([r,c],[r,c+1],[r,c+2]);
            }
        }
    }
    for(let c=0;c<boardSize;c++){
        for(let r=0;r<boardSize-2;r++){
            if(board[r][c]!=='' && board[r][c]===board[r+1][c] && board[r][c]===board[r+2][c]){
                matchFound=true; remove.push([r,c],[r+1,c],[r+2,c]);
            }
        }
    }
    if(matchFound){
        remove.forEach(([r,c])=>{
            if(board[r][c]===questTarget) questCount++;
            board[r][c]=''; score+=10;
        });
        document.getElementById('score').innerText='‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: '+score;
        document.getElementById('quest').innerText=`‡πÄ‡∏Ñ‡∏ß‡∏™: ‡πÄ‡∏Å‡πá‡∏ö ${questTarget} ${questCount}/${questGoal}`;
        collapseBoard();
    }
    return matchFound;
}
function collapseBoard(){
    for(let c=0;c<boardSize;c++){
        let empty=0;
        for(let r=boardSize-1;r>=0;r--){
            if(board[r][c]==='') empty++;
            else if(empty>0){ board[r+empty][c]=board[r][c]; board[r][c]=''; }
        }
        for(let r=0;r<empty;r++){ board[r][c]=fruits[Math.floor(Math.random()*fruits.length)]; }
    }
    renderBoard();
    setTimeout(checkMatches,200);
}

// Win/Lose check
function checkWin(){
    if(questCount>=questGoal){ level++; startNextLevel(); }
    if(movesLeft<=0){ alert('‡πÅ‡∏û‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:'+score); resetGame(); }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
function startNextLevel(){
    movesLeft = 20 + level*2; questTarget=fruits[Math.floor(Math.random()*fruits.length)];
    questCount=0; questGoal=5+level;
    document.getElementById('level').innerText='‡∏î‡πà‡∏≤‡∏ô: '+level;
    updateMoves();
    initBoard();
    renderBoard();
}

// Update moves UI
function updateMoves(){ document.getElementById('moves').innerText='‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: '+movesLeft; }

// Swipe ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
let touchStart=null;
boardEl.addEventListener('touchstart', e=>{
    const rect = boardEl.getBoundingClientRect();
    const touch = e.touches[0];
    const x=touch.clientX-rect.left, y=touch.clientY-rect.top;
    const c=Math.floor(x/62), r=Math.floor(y/62);
    selectCandy(r,c);
});
boardEl.addEventListener('touchmove', e=>{
    if(!selected) return;
    const rect = boardEl.getBoundingClientRect();
    const touch = e.touches[0];
    const x=touch.clientX-rect.left, y=touch.clientY-rect.top;
    const c=Math.floor(x/62), r=Math.floor(y/62);
    if(isAdjacent(selected,{r,c})){ swap(selected,{r,c}); selected=null; movesLeft--; updateMoves(); }
});

// Click PC
boardEl.addEventListener('click', e=>{
    const target = e.target;
    if(!target.classList.contains('candy')) return;
    const r=parseInt(target.dataset.row), c=parseInt(target.dataset.col);
    selectCandy(r,c);
});

// Chocolate Lightning ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏Å‡∏î C
window.addEventListener('keydown', e=>{
    if(e.key.toLowerCase()==='c'){ 
        for(let r=0;r<boardSize;r++){ for(let c=0;c<boardSize;c++){
            if(board[r][c]===questTarget) board[r][c]='';
        }}
        collapseBoard();
    }
});

initBoard();
renderBoard();
updateMoves();
</script>

</body>
</html>
