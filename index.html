<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iBitPaint Cute Pink</title>

<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');

body{
  margin:0;
  font-family:'Comic Neue', cursive;
  background:#ffe6f0;
  overflow:hidden;
}

/* Toolbar */
#toolbar{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(255, 192, 203,0.95);
  padding:10px;
  border-radius:25px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  box-shadow:0 8px 20px rgba(255, 105, 180,0.3);
  z-index:20;
}
#toolbar > *{
  padding:6px 12px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-size:14px;
  background:#fff;
  transition:0.2s;
}
#toolbar > *:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 10px rgba(255, 105, 180,0.25);
}

/* Canvas */
#canvasContainer{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}
canvas{
  background:#fff0f5;
  border-radius:12px;
  margin:auto;
}

/* Room UI */
#roomCode{
  position:fixed;
  top:15px;
  right:15px;
  background:linear-gradient(135deg,#ffb6c1,#ff69b4);
  color:#fff;
  padding:8px 12px;
  border-radius:15px;
  font-weight:bold;
  box-shadow:0 5px 15px rgba(255,105,180,0.3);
  z-index:15;
}

/* Join Room */
#joinRoom{
  position:fixed;
  bottom:15px;
  right:15px;
  padding:8px;
  background:linear-gradient(135deg,#ffb6c1,#ff69b4);
  color:#fff;
  border-radius:12px;
  display:flex;
  gap:6px;
  z-index:15;
}
#joinRoom input{
  padding:4px 6px;
  border-radius:8px;
  border:1px solid #ccc;
  width:80px;
}

/* Layer Panel */
#layerPanel{
  position:fixed;
  top:70px;
  right:15px;
  background:rgba(255,192,203,0.95);
  padding:10px;
  border-radius:12px;
  max-height:300px;
  overflow-y:auto;
  box-shadow:0 5px 15px rgba(255,105,180,0.25);
  z-index:15;
}
.layerItem{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.layerItem button{padding:2px 4px; font-size:12px; border-radius:8px;}

/* Chat Panel */
#chatPanel{
  position:fixed;
  top:70px;
  left:15px;
  width:220px;
  height:400px;
  background:rgba(255,192,203,0.95);
  padding:10px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(255,105,180,0.25);
  z-index:15;
  display:flex;
  flex-direction:column;
}
#chatMessages{
  flex:1;
  overflow-y:auto;
  margin-bottom:6px;
}
#chatInput{
  display:flex;
  gap:4px;
}
#chatInput input{
  flex:1;
  padding:4px 6px;
  border-radius:6px;
  border:1px solid #ccc;
}
</style>
</head>
<body>

<div id="toolbar">
Brush: <select id="brushSelect"></select>
Size: <input type="range" id="sizePicker" min="1" max="50" value="5">
Opacity: <input type="range" id="opacityPicker" min="0.1" max="1" step="0.1" value="1">
Color: <input type="color" id="colorPicker" value="#ff69b4">
<button id="eraserBtn">ü©π Eraser</button>
<button id="undoBtn">‚Ü©Ô∏è Undo</button>
<button id="redoBtn">‚Ü™Ô∏è Redo</button>
<button id="clearBtn">üóëÔ∏è Clear</button>
<button id="saveBtn">üíæ Save PNG</button>
</div>

<div id="roomCode">Room: ---</div>
<div id="joinRoom">
<input id="joinInput" placeholder="room code"><button id="joinBtn">Join</button>
</div>

<div id="layerPanel"></div>

<div id="chatPanel">
<div id="chatMessages"></div>
<div id="chatInput">
<input id="chatText" placeholder="Type message"><button id="sendChat">Send</button>
</div>
</div>

<div id="canvasContainer">
<canvas id="canvas" width="2000" height="2000"></canvas>
</div>

<script>
/* =======================
Firebase Init
========================== */
const firebaseConfig = {
apiKey:"YOUR_API_KEY",
authDomain:"YOUR_AUTH_DOMAIN",
databaseURL:"YOUR_DATABASE_URL",
projectId:"YOUR_PROJECT_ID",
storageBucket:"YOUR_STORAGE_BUCKET",
messagingSenderId:"YOUR_MESSAGING_SENDER_ID",
appId:"YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* =======================
Canvas Setup
========================== */
const canvas = new fabric.Canvas('canvas',{isDrawingMode:true});
canvas.selection=false;

const brushSelect=document.getElementById('brushSelect');
for(let i=1;i<=20;i++){
  const opt=document.createElement('option');
  opt.value='brush'+i;
  opt.text='Brush '+i;
  brushSelect.appendChild(opt);
}
const brushMap={};
for(let i=1;i<=20;i++){
  brushMap['brush'+i]=new fabric.PencilBrush(canvas);
}
let isEraser=false;
let playerName='User'+Math.floor(Math.random()*1000);
function setBrush(name){
  isEraser=false;
  canvas.freeDrawingBrush=brushMap[name];
  canvas.freeDrawingBrush.width=document.getElementById('sizePicker').value;
  canvas.freeDrawingBrush.color=document.getElementById('colorPicker').value;
  canvas.freeDrawingBrush.opacity=document.getElementById('opacityPicker').value;
}
brushSelect.onchange=()=>setBrush(brushSelect.value);

// Eraser
document.getElementById('eraserBtn').onclick=()=>{
isEraser=true;
canvas.freeDrawingBrush=new fabric.EraserBrush(canvas);
canvas.freeDrawingBrush.width=document.getElementById('sizePicker').value;
}

/* Toolbar events */
document.getElementById('sizePicker').oninput=e=>canvas.freeDrawingBrush.width=e.target.value;
document.getElementById('colorPicker').onchange=e=>canvas.freeDrawingBrush.color=e.target.value;
document.getElementById('opacityPicker').oninput=e=>canvas.freeDrawingBrush.opacity=e.target.value;

/* Undo/Redo */
let history=[],historyStep=-1;
function saveHistory(){
history=history.slice(0,historyStep+1);
history.push(JSON.stringify(canvas));
historyStep++;
}
function undo(){ if(historyStep>0){historyStep--; canvas.loadFromJSON(history[historyStep],()=>canvas.renderAll());}}
function redo(){ if(historyStep<history.length-1){historyStep++; canvas.loadFromJSON(history[historyStep],()=>canvas.renderAll());}}
document.getElementById('undoBtn').onclick=undo;
document.getElementById('redoBtn').onclick=redo;
canvas.on('path:created', saveHistory);

/* Clear & Save */
document.getElementById('clearBtn').onclick=()=>{
canvas.clear(); broadcastClear();
};
document.getElementById('saveBtn').onclick=()=>{
const link=document.createElement('a');
link.download='drawing.png';
link.href=canvas.toDataURL({format:'png'});
link.click();
};

/* =======================
Join Room & Realtime
========================== */
let roomCode=document.getElementById('roomCode').innerText.split(' ')[1];
if(roomCode==='---'){ roomCode=Math.floor(Math.random()*9000+1000).toString();
document.getElementById('roomCode').innerText='Room: '+roomCode;}

document.getElementById('joinBtn').onclick=()=>{
const code=document.getElementById('joinInput').value.trim();
if(!code) return;
roomCode=code;
document.getElementById('roomCode').innerText='Room: '+roomCode;
};

// Realtime drawing
db.ref('rooms/'+roomCode+'/paths').on('child_added', snap=>{
const data=snap.val();
fabric.util.enlivenObjects([data.object],objects=>{
objects.forEach(o=>canvas.add(o));
canvas.renderAll();
});
});
db.ref('rooms/'+roomCode+'/clear').on('value',snap=>{if(snap.val()) canvas.clear();});

// Broadcast draw
canvas.on('path:created', e=>{
const obj=e.path.toObject(['stroke','strokeWidth','fill']);
db.ref('rooms/'+roomCode+'/paths').push({object:obj,player:playerName});
});
function broadcastClear(){ db.ref('rooms/'+roomCode+'/clear').set(true); }

/* =======================
Chat Realtime
========================== */
const chatMessages=document.getElementById('chatMessages');
document.getElementById('sendChat').onclick=()=>{
const text=document.getElementById('chatText').value.trim();
if(!text) return;
db.ref('rooms/'+roomCode+'/chat').push({player:playerName,text});
document.getElementById('chatText').value='';
};
db.ref('rooms/'+roomCode+'/chat').on('child_added', snap=>{
const msg=snap.val();
const div=document.createElement('div');
div.textContent=`${msg.player}: ${msg.text}`;
chatMessages.appendChild(div);
chatMessages.scrollTop=chatMessages.scrollHeight;
});
</script>

</body>
</html>
